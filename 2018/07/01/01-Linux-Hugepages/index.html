<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>A Note on Linux Hugepages | Kevin Hu&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Page table is where Linux stores virtual to physical page address translation, and its size can get huge when memory usage is high. One way to reduce the size of page tables, and reduce the number of">
<meta name="keywords" content="Linux,Programming,Hugepage">
<meta property="og:type" content="article">
<meta property="og:title" content="A Note on Linux Hugepages">
<meta property="og:url" content="https://blog.kevinhu.me/2018/07/01/01-Linux-Hugepages/index.html">
<meta property="og:site_name" content="Kevin Hu&#39;s Blog">
<meta property="og:description" content="Page table is where Linux stores virtual to physical page address translation, and its size can get huge when memory usage is high. One way to reduce the size of page tables, and reduce the number of">
<meta property="og:locale" content="en-US">
<meta property="og:updated_time" content="2018-07-02T00:57:58.976Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="A Note on Linux Hugepages">
<meta name="twitter:description" content="Page table is where Linux stores virtual to physical page address translation, and its size can get huge when memory usage is high. One way to reduce the size of page tables, and reduce the number of">
  
    <link rel="alternative" href="/atom.xml" title="Kevin Hu&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-57072621-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Kevin Hu&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">A Hungry Fool</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/About/">About</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.kevinhu.me"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-01-Linux-Hugepages" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/01/01-Linux-Hugepages/" class="article-date">
  <time datetime="2018-07-01T23:30:20.000Z" itemprop="datePublished">07 01 2018</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Programming/">Programming</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      A Note on Linux Hugepages
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Page table is where Linux stores virtual to physical page address translation, and its size can get huge when memory usage is high. One way to reduce the size of page tables, and reduce the number of page faults, is to use huge pages. Iâ€™ve been digging some information on hugepages for my own curiosity, and it looks like Linux has pretty good support for huge pages. And this blog serves as a quick note on my readings.</p>
<a id="more"></a>
<h2 id="Hugepages"><a href="#Hugepages" class="headerlink" title="Hugepages"></a>Hugepages</h2><p>The sysctl directory contains <code>/sys/kernel/mm/hugepages/hugepages-{pagesize}kB/</code> control files and information on hugepages, where pagesize could be 1048576 or 2048, corresponding to 1GB or 2MB of hugepage size.</p>
<p>To get information on hugepages on your Linux systems, the <code>hugepages</code> directory contains the controlling files:</p>
<ul>
<li><code>nr_hugepages</code></li>
<li><code>nr_hugepages_mempolicy</code></li>
<li><code>nr_overcommit_hugepages</code></li>
<li><code>free_hugepages</code></li>
<li><code>resv_hugepages</code></li>
<li><code>surplus_hugepages</code>.</li>
</ul>
<p>You can also get hugepage-related information from <code>/proc/meminfo</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HugePages_Total:    2048</span><br><span class="line">HugePages_Free:        0</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br></pre></td></tr></table></figure>
<p>The <a href="https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt" target="_blank" rel="noopener">Kernel Documentation of Hugetlbpage</a> contains the detailed information and explanation of the purpose and usage of hugepage files, as well as <code>meminfo</code> fields.</p>
<h2 id="Allocating-Hugepages"><a href="#Allocating-Hugepages" class="headerlink" title="Allocating Hugepages"></a>Allocating Hugepages</h2><p>The most convenient way to reserve hugepages on x86_64 Linux is to echo into the sysctl file <code>/sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages</code>, e.g.:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># echo 1024 &gt; /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages</span><br></pre></td></tr></table></figure>
<p>And for user to access and use the huge pages, Linux actually provides a quite convenient interface: the <code>hugetlbfs</code> file system, e.g.:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t hugetlbfs nodev /mnt/huge</span><br></pre></td></tr></table></figure>
<p>Which mounts a pseudo filesystem of type <code>hugetlbfs</code> on <code>/mnt/huge</code>, and uses the default huge pagesize specified by the system, and all files created inside the directory uses huge pages.</p>
<p>And after that, you can use hugepage-backed memory by creating files inside <code>/mnt/huge</code> directory. See example in Linux source tree: <a href="https://github.com/torvalds/linux/blob/master/tools/testing/selftests/vm/hugepage-mmap.c" target="_blank" rel="noopener">hugepage-mmap.c</a>. The author takes the following steps:</p>
<ul>
<li>Open a file inside <code>/mnt</code> with read-write permission.</li>
<li>Map memory to the file using <code>mmap</code>, with proper protection and flags set (<code>PROT_READ | PROR_WRITE</code> and <code>MAP_SHARED</code> in this case).</li>
<li>Use the hugepage-backed memory as usual.</li>
<li>Clean up memory and file.</li>
</ul>
<h2 id="Enable-Hugepage-On-Start"><a href="#Enable-Hugepage-On-Start" class="headerlink" title="Enable Hugepage On Start"></a>Enable Hugepage On Start</h2><p>According to Linux <a href="https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt" target="_blank" rel="noopener">Kernel Documentation</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">System administrators may want to put this command in one of the local rc</span><br><span class="line">init files.  This will enable the kernel to allocate huge pages early in</span><br><span class="line">the boot process when the possibility of getting physical contiguous pages</span><br><span class="line">is still very high.</span><br></pre></td></tr></table></figure>
<p>And to quote the <a href="https://lwn.net/Articles/376606/" target="_blank" rel="noopener">LWN article</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">If the huge page pool is statically allocated at boot-time, then this section</span><br><span class="line">will not be relevant as the huge pages are guaranteed to exist. In the event</span><br><span class="line">the system needs to dynamically allocate huge pages throughout its lifetime,</span><br><span class="line">then external fragmentation may be a problem.</span><br></pre></td></tr></table></figure>
<p>So to avoid external fragmentation and make sure that the hugepage allocation is always successful, we may want to reserve hugepages memory regions on boot time. This <a href="https://wiki.debian.org/Hugepages" target="_blank" rel="noopener">Debian Wiki Page</a> provides a way to do that. To reserve number of hugepages, add the following line in <code>/etc/sysctl.conf</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.nr_hugepages = 1024</span><br></pre></td></tr></table></figure>
<p>And to mount it automatically on system start, simply add to <code>/etc/fstab</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hugetlbfs /hugepages hugetlbfs mode=1770,gid=2021 0 0</span><br></pre></td></tr></table></figure>
<h2 id="Advanced-Topics"><a href="#Advanced-Topics" class="headerlink" title="Advanced Topics"></a>Advanced Topics</h2><p>There are other advanced topics, which probably will not be covered in the scope of this quick note:</p>
<ul>
<li><strong>Transparent Huge Pages</strong>: system automatically decides if memory should be backed by hugepages, which make usage of hugepage memory much easier.</li>
<li><strong>libhugetlbfs APIs</strong>: <code>libhugetlbfs</code> provides programmer APIs to manage and access hugepage memory as well. Hugepage library utilities <code>hugectl</code> can overload Linux standard <code>shmget()</code> functions to allow huge pages to be used by allocating shared memory.</li>
<li><strong>Text And Data</strong>: <code>hugectl</code> has options to run an application, with its <code>text</code> and <code>data</code> section mapped by hugepages, which gives potential performance benefits.</li>
</ul>
<p>These are ideas worth digging into in the future, for applications where hugepages can potential give a good performance boost.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt" target="_blank" rel="noopener">Kernel Documentation of Hugetlbpage</a></li>
<li><a href="https://lwn.net/Articles/374424/" target="_blank" rel="noopener">LWN Intro to Huge Pages (1 Intro)</a></li>
<li><a href="https://lwn.net/Articles/375096/" target="_blank" rel="noopener">LWN Intro to Huge Pages (2 Interfaces)</a></li>
<li><a href="https://lwn.net/Articles/375096/" target="_blank" rel="noopener">LWN Intro to Huge Pages (3 Administration)</a></li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/performance_tuning_guide/s-memory-transhuge#s-memory-configure_hugepages" target="_blank" rel="noopener">Redhat Documentation on Performance Tuning: 5.2 Huge Pages And Transparent Huge Pages</a></li>
<li><a href="https://github.com/torvalds/linux/blob/master/tools/testing/selftests/vm/hugepage-mmap.c" target="_blank" rel="noopener">hugepage-mmap.c: Hugepage example in Linux source tree</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.kevinhu.me/2018/07/01/01-Linux-Hugepages/" data-id="cjj3i9ict0000cvscfgw03bo3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hugepage/">Hugepage</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Programming/">Programming</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/07/09/09-2018-07-09-Reading-Summary/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Reading-Summary 2018-06
        
      </div>
    </a>
  
  
    <a href="/2018/05/21/2018-05-21-Reading-Summary/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Reading-Summary 2018-05</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/">Algorithm</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CodeReading/">CodeReading</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Diary/">Diary</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Programming/">Programming</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ProgrammingLanguage/">ProgrammingLanguage</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Reading/">Reading</a><span class="category-list-count">16</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Algorithm/" style="font-size: 10px;">Algorithm</a> <a href="/tags/BitHacks/" style="font-size: 10px;">BitHacks</a> <a href="/tags/C/" style="font-size: 10px;">C</a> <a href="/tags/C/" style="font-size: 10px;">C++</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/CodeReading/" style="font-size: 15px;">CodeReading</a> <a href="/tags/Coding/" style="font-size: 10px;">Coding</a> <a href="/tags/Compilers/" style="font-size: 15px;">Compilers</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Hugepage/" style="font-size: 10px;">Hugepage</a> <a href="/tags/Internet-BookReview/" style="font-size: 10px;">Internet, BookReview</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Multithread/" style="font-size: 10px;">Multithread</a> <a href="/tags/PaperReading/" style="font-size: 10px;">PaperReading</a> <a href="/tags/Password/" style="font-size: 15px;">Password</a> <a href="/tags/Programming/" style="font-size: 15px;">Programming</a> <a href="/tags/ProgrammingLanguage/" style="font-size: 15px;">ProgrammingLanguage</a> <a href="/tags/Python/" style="font-size: 20px;">Python</a> <a href="/tags/Social/" style="font-size: 10px;">Social</a> <a href="/tags/Technology/" style="font-size: 15px;">Technology</a> <a href="/tags/Undefined-Behavior/" style="font-size: 15px;">Undefined Behavior</a> <a href="/tags/WeeklyPaper/" style="font-size: 10px;">WeeklyPaper</a> <a href="/tags/systems/" style="font-size: 10px;">systems</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/10/14/14-Reading-Summary-2018-10/">Reading-Summary 2018-10-14</a>
          </li>
        
          <li>
            <a href="/2018/09/09/Weekly-Paper-Reading-1-DCLP/">Weekly paper reading: C++ and the Perils of Double-Checked Locking</a>
          </li>
        
          <li>
            <a href="/2018/07/09/09-2018-07-09-Reading-Summary/">Reading-Summary 2018-06</a>
          </li>
        
          <li>
            <a href="/2018/07/01/01-Linux-Hugepages/">A Note on Linux Hugepages</a>
          </li>
        
          <li>
            <a href="/2018/05/21/2018-05-21-Reading-Summary/">Reading-Summary 2018-05</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Kevin Hu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/About/" class="mobile-nav-link">About</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>